name: Tauri CI

on:
  push:
    branches: 
      - main
      - develop
      - mvp/stable
      - customized/stable
  pull_request:

jobs:
  build-tauri:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # 1. Checkout
      # ------------------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 2. Node + pnpm
      # ------------------------------------------------------------
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      # ------------------------------------------------------------
      # 3. Rust (Tauri)
      # ------------------------------------------------------------
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      # ------------------------------------------------------------
      # 4. System deps for Tauri (Linux)
      # ------------------------------------------------------------
      - name: Install Tauri Linux dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev

      # ------------------------------------------------------------
      # 5. Python (Backend)
      # ------------------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ------------------------------------------------------------
      # 6. Frontend: install + static export
      # ------------------------------------------------------------
      - name: Install frontend deps
        working-directory: frontend
        run: pnpm install

      - name: Build frontend static export
        working-directory: frontend
        run: pnpm export

      - name: Validate frontend export
        run: |
          test -f frontend/out/index.html

      # ------------------------------------------------------------
      # 7. Backend: setup virtual environment
      # ------------------------------------------------------------
      - name: Install backend deps
        working-directory: backend
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install -r requirements.txt

      - name: Validate backend setup
        working-directory: backend
        run: |
          source .venv/bin/activate
          python -c "import fastapi; import sqlmodel; import uvicorn; print('âœ… Backend dependencies OK')"

      # ------------------------------------------------------------
      # 8. Tauri build (Smoke Test)
      # ------------------------------------------------------------
      - name: Tauri build
        run: pnpm tauri build

      # ------------------------------------------------------------
      # 9. Validate bundle output
      # ------------------------------------------------------------
      - name: Validate Tauri bundle
        run: |
          ls src-tauri/target/release/bundle
